# redeven-agent Development and Release Guide

> Scope: this repository (`redeven-agent/`).
>
> Goal: keep development, release, Cloudflare package mirror, and install-worker deployment consistent and auditable.

---

## 1. Git workflow (Worktree, required)

- Never develop directly on `main`.
- Every change must be done in a dedicated worktree + feature branch.
- `main` is only for `pull --ff-only` and merges.
- Resolve conflicts only inside the feature worktree, never on `main`.

Recommended template:

```bash
git fetch origin
git switch main
git pull --ff-only

BR=feat-<topic>
WT=../redeven-agent-feat-<topic>
git worktree add -b "$BR" "$WT" origin/main
```

Merge and cleanup:

```bash
git switch main
git pull --ff-only
git merge --no-ff "$BR"
git push origin main

git worktree remove "$WT"
git branch -d "$BR"
```

## 1.1 Repository language policy (required)

- All committed files in `redeven-agent` must be English-only, including:
  - source code and identifiers/messages where practical
  - code comments
  - Markdown and other documentation files
  - scripts, examples, and test fixtures that are maintained in-repo
- If a protocol/sample originally contains non-English content, prefer an English equivalent before committing.

## 1.2 AI design principle (required)

- **Prompt-first policy**: prefer guiding model behavior through prompts and structured contracts; runtime logic should enforce safety and consistency, not replace model understanding with business heuristics.
- **No scenario-specific hardcoding**: do not add keyword/string-match special cases for one-off user scenarios (for example, ad-hoc phrase detectors that force complexity or workflow).
- **Generalization over exceptions**: AI orchestration changes must target a unified mechanism that scales across diverse user requests, instead of stacking per-case branches.
- **Explainable decisions**: intent/policy decisions must be observable through events/log fields so operators can audit why a decision was made and improve the system safely.

## 2. Release (full release)

### 2.1 Agent binary release (GitHub Release)

- Tag format: `vX.Y.Z`.
- Pushing the tag triggers `.github/workflows/release.yml`.
- Artifacts and signing files are published in GitHub Release.
- Release notes must include an operator-friendly preface (`scripts/generate_release_notes.sh`) plus GitHub auto-generated change notes.

### 2.2 Private Ops dispatch (automatic)

- Trigger point: `.github/workflows/release.yml` job `Notify Private Ops`.
- Event type: `redeven_agent_release_published`.
- Payload:
  - `release_repo` = `${{ github.repository }}`
  - `release_tag` = `${{ github.ref_name }}`
  - `recommended_version` = `${{ github.ref_name }}`

Required repository secrets:

- `REDEVEN_PRIVATE_OPS_DISPATCH_TOKEN`
- `REDEVEN_PRIVATE_OPS_TARGET_REPO` (format: `owner/repo`)

Failure policy:

- Dispatch step fails fast and marks release workflow failed.
- GitHub Release artifacts stay immutable.

### 2.3 Cloudflare package mirror + manifest worker (handled by Private Ops)

- Private Ops workflow mirrors verified release assets to Cloudflare R2 (`agent-install-pkg/<tag>/...`).
- Private Ops workflow deploys and updates the version-manifest Worker (`https://version.agent.example.invalid/v1/manifest.json`).

### 2.4 install.sh delivery

- `install.sh` source of truth: `scripts/install.sh`
- Download order in installer:
  - Primary: GitHub Release
  - Fallback: Cloudflare package mirror

### 2.5 Install worker deployment (separate flow)

- Cloudflare Worker build/deploy is managed in Cloudflare Workers Builds.
- Production branch is fixed to `release`.
- Ensure `release` branch exists once:

```bash
git push origin origin/main:refs/heads/release
```

- Use this command only when installer/worker sources changed and need rollout:

```bash
./scripts/publish_install_worker_release_branch.sh vX.Y.Z
```

## 3. Pre-commit checks (required)

- `sh -n scripts/install.sh`
- `sh -n scripts/publish_install_worker_release_branch.sh`
- `sh -n scripts/generate_release_notes.sh`
- `./scripts/build_assets.sh`
- `go test ./...`
- `golangci-lint run ./...`
