# redeven-agent Development and Release Guide

> Scope: this repository (`redeven-agent/`).
>
> Goal: keep development, release, Cloudflare package mirror, and install-worker deployment consistent and auditable.

---

## 1. Git workflow (Worktree, required)

- Never develop directly on `main`.
- Every change must be done in a dedicated worktree + feature branch.
- `main` is only for `pull --ff-only` and merges.
- Resolve conflicts only inside the feature worktree, never on `main`.

Recommended template:

```bash
git fetch origin
git switch main
git pull --ff-only

BR=feat-<topic>
WT=../redeven-agent-feat-<topic>
git worktree add -b "$BR" "$WT" origin/main
```

Merge and cleanup:

```bash
git switch main
git pull --ff-only
git merge --no-ff "$BR"
git push origin main

git worktree remove "$WT"
git branch -d "$BR"
```

## 2. Release (full release)

### 2.1 Agent binary release (GitHub Release)

- Tag format: `vX.Y.Z`.
- Pushing the tag triggers `.github/workflows/release.yml`.
- Artifacts and signing files are published in GitHub Release.

### 2.2 Cloudflare package mirror + manifest (automatic)

- Workflow: `.github/workflows/sync-release-assets-to-r2.yml`
- Script: `scripts/sync_release_assets_to_r2.sh`
- Trigger: `release.published` (plus manual `workflow_dispatch` for re-sync)

Workflow contract:

1. Download release assets from GitHub Release.
2. Verify checksum and Cosign signature.
3. Mirror files to Cloudflare R2 under `agent-install-pkg/<tag>/...`.
4. Verify uploaded file hashes by re-downloading from R2.
5. Update `v1/manifest.json` only after mirror verification succeeds.

Required repository secrets:

- `CLOUDFLARE_R2_ENDPOINT`
- `CLOUDFLARE_R2_ACCESS_KEY_ID`
- `CLOUDFLARE_R2_SECRET_ACCESS_KEY`
- `CLOUDFLARE_AGENT_PACKAGE_BUCKET`
- `CLOUDFLARE_AGENT_VERSION_BUCKET`

Failure policy:

- Mirror workflow fails fast.
- Existing manifest stays unchanged.
- GitHub Release remains immutable.

### 2.3 install.sh delivery

- `install.sh` source of truth: `scripts/install.sh`
- Download order in installer:
  - Primary: GitHub Release
  - Fallback: Cloudflare package mirror

### 2.4 Install worker deployment (separate flow)

- Cloudflare Worker build/deploy is managed in Cloudflare Workers Builds.
- Production branch is fixed to `release`.
- Ensure `release` branch exists once:

```bash
git push origin origin/main:refs/heads/release
```

- Use this command only when installer/worker sources changed and need rollout:

```bash
./scripts/publish_install_worker_release_branch.sh vX.Y.Z
```

## 3. Pre-commit checks (required)

- `sh -n scripts/install.sh`
- `sh -n scripts/publish_install_worker_release_branch.sh`
- `sh -n scripts/sync_release_assets_to_r2.sh`
- `./scripts/build_assets.sh`
- `go test ./...`
- `golangci-lint run ./...`
