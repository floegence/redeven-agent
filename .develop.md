# redeven-agent Development and Release Guide

> Scope: this repository (`redeven-agent/`).
>
> Goal: keep development, release, and Cloudflare install-worker deployment consistent and auditable.

---

## 1. Git Workflow (Worktree, required)

- Never develop directly on `main`.
- Every change must be done in a dedicated worktree + feature branch.
- `main` is only for `pull --ff-only` and merges.
- Resolve conflicts only inside the feature worktree, never on `main`.

Recommended template:

```bash
git fetch origin
git switch main
git pull --ff-only

BR=feat-<topic>
WT=../redeven-agent-feat-<topic>
git worktree add -b "$BR" "$WT" origin/main
```

Merge and cleanup:

```bash
git switch main
git pull --ff-only
git merge --no-ff "$BR"
git push origin main

git worktree remove "$WT"
git branch -d "$BR"
```

## 2. Release (full release)

### 2.1 Agent binary release (GitHub Release)

- Tag format: `vX.Y.Z`.
- Pushing the tag triggers `.github/workflows/release.yml` to build and publish artifacts.

### 2.2 install.sh release (Cloudflare Workers Builds)

- `install.sh` source of truth: `scripts/install.sh`.
- Cloudflare must integrate directly with GitHub repository builds.
- Do not use GitHub Actions to deploy the install worker.
- Production branch for Cloudflare is fixed to `release`.
- Regular merges into `main` must not deploy the install worker.

Cloudflare one-time setup:

1. Repository: `floegence/redeven-agent`
2. Production branch: `release`
3. Root directory: `deployment/cloudflare/workers/install-agent`
4. Build command: `node generate-worker.js`
5. Deploy command: `npx wrangler deploy --config wrangler.toml`

If `release` branch does not exist on origin yet, create it once:

```bash
git push origin origin/main:refs/heads/release
```

### 2.3 Tag-driven Cloudflare deployment

After publishing a tag, move `release` to the tagged commit:

```bash
./scripts/publish_install_worker_release_branch.sh vX.Y.Z
```

This force-updates `release` to the tag commit, which triggers Cloudflare Workers Builds deployment.

## 3. Pre-commit checks (required)

- `sh -n scripts/install.sh`
- `sh -n scripts/publish_install_worker_release_branch.sh`
- `./scripts/build_assets.sh`
- `go test ./...`
- `golangci-lint run ./...`

