name: Sync Release Assets to Cloudflare R2

on:
  release:
    types:
      - published
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag to sync (for example: v0.1.12)"
        required: true
        type: string
      recommended:
        description: "Optional recommended version override (defaults to tag)"
        required: false
        type: string

permissions:
  contents: read

concurrency:
  group: sync-release-assets-${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag || github.event.release.tag_name }}
  cancel-in-progress: false

jobs:
  sync:
    runs-on: ubuntu-latest
    env:
      RELEASE_REPO: floegence/redeven-agent
      RELEASE_TAG: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag || github.event.release.tag_name }}
      RECOMMENDED_VERSION: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.recommended || '' }}

      # R2 object storage endpoint (for example: https://<accountid>.r2.cloudflarestorage.com)
      R2_ENDPOINT: ${{ secrets.CLOUDFLARE_R2_ENDPOINT }}
      AWS_ACCESS_KEY_ID: ${{ secrets.CLOUDFLARE_R2_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.CLOUDFLARE_R2_SECRET_ACCESS_KEY }}
      AWS_REGION: auto

      # Package mirror destination
      R2_PACKAGE_BUCKET: ${{ secrets.CLOUDFLARE_AGENT_PACKAGE_BUCKET }}
      R2_PACKAGE_PREFIX: agent-install-pkg

      # Worker deployment credentials (for version manifest endpoint)
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install cosign
        uses: sigstore/cosign-installer@v3

      - name: Validate required secrets
        run: |
          set -euo pipefail
          REQUIRED=(
            R2_ENDPOINT
            AWS_ACCESS_KEY_ID
            AWS_SECRET_ACCESS_KEY
            R2_PACKAGE_BUCKET
            CLOUDFLARE_API_TOKEN
            CLOUDFLARE_ACCOUNT_ID
          )
          for key in "${REQUIRED[@]}"; do
            if [ -z "${!key}" ]; then
              echo "::error::Missing required repository secret mapping: $key"
              exit 1
            fi
          done

      - name: Sync release assets to package mirror
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: ./scripts/sync_release_assets_to_r2.sh

      - name: Prepare manifest worker variables
        id: manifest_vars
        run: |
          set -euo pipefail
          resolved_recommended="${RECOMMENDED_VERSION:-$RELEASE_TAG}"
          echo "recommended_version=$resolved_recommended" >> "$GITHUB_OUTPUT"
          echo "updated_at=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> "$GITHUB_OUTPUT"

      - name: Deploy version manifest worker
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: deployment/cloudflare/workers/version-manifest
          command: >-
            deploy --config wrangler.toml
            --var LATEST_VERSION:${{ env.RELEASE_TAG }}
            --var RECOMMENDED_VERSION:${{ steps.manifest_vars.outputs.recommended_version }}
            --var UPDATED_AT:${{ steps.manifest_vars.outputs.updated_at }}
            --var SOURCE_RELEASE_TAG:${{ env.RELEASE_TAG }}
