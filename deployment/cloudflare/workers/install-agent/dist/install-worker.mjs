// Auto-generated from scripts/install.sh
// Do not edit this file manually. Run generate-worker.js instead.
const INSTALL_SCRIPT = "#!/bin/sh\n# Redeven CLI Installation Script\n#\n# This script downloads and installs the latest Redeven agent binary\n# from the floegence/redeven-agent GitHub repository.\n#\n# Usage: curl -fsSL https://install.example.invalid/install.sh | sh\n#\n# Optional:\n#   REDEVEN_VERSION=v1.2.3 curl -fsSL https://install.example.invalid/install.sh | sh\n#\n# The script will:\n# 1. Detect your OS and architecture\n# 2. Resolve target version from REDEVEN_VERSION_MANIFEST_URL\n#    (or REDEVEN_VERSION when explicitly provided)\n# 3. Download the release package and release checksums with fallback support:\n#    - Primary: GitHub releases\n#    - Fallback: Cloudflare CDN (REDEVEN_PACKAGE_MIRROR_BASE_URL)\n# 4. Verify checksum + signature before extraction\n# 5. Install to /usr/local/bin/redeven (or ~/.redeven/bin/redeven)\n\nset -e\n\n# Colors for output\nRED='\\033[0;31m'\nGREEN='\\033[0;32m'\nYELLOW='\\033[1;33m'\nNC='\\033[0m' # No Color\n\n# GitHub repository for releases\nGITHUB_REPO=\"floegence/redeven-agent\"\nGITHUB_RELEASES_URL=\"https://github.com/${GITHUB_REPO}/releases\"\n\n# Binary name\nBINARY_NAME=\"redeven\"\n\n# Public URL templates. Production values should be injected by private ops.\nREDEVEN_INSTALL_SCRIPT_URL=\"${REDEVEN_INSTALL_SCRIPT_URL:-https://install.example.invalid/install.sh}\"\nREDEVEN_VERSION_MANIFEST_URL=\"${REDEVEN_VERSION_MANIFEST_URL:-https://version.agent.example.invalid/v1/manifest.json}\"\nREDEVEN_PACKAGE_MIRROR_BASE_URL=\"${REDEVEN_PACKAGE_MIRROR_BASE_URL:-https://agent.package.example.invalid}\"\nREDEVEN_CONSOLE_URL=\"${REDEVEN_CONSOLE_URL:-https://console.example.invalid}\"\nREDEVEN_DOCS_URL=\"${REDEVEN_DOCS_URL:-https://docs.example.invalid}\"\n\n# Shell-first tooling: pinned ripgrep distribution.\nRG_VERSION=\"14.1.1\"\nRG_GITHUB_RELEASES_URL=\"https://github.com/BurntSushi/ripgrep/releases\"\nRG_MIRROR_BASE_URL=\"${REDEVEN_RG_MIRROR_BASE_URL:-${REDEVEN_PACKAGE_MIRROR_BASE_URL}/third-party/ripgrep}\"\n\n# Redeven home directory - config is written to ~/.redeven/config.json (default)\nREDEVEN_HOME=\"${HOME}/.redeven\"\nREDEVEN_TOOLS_DIR=\"${REDEVEN_HOME}/tools\"\n\n# Install mode:\n# - install (default): install flow (configure PATH, print onboarding)\n# - upgrade: upgrade-only flow (skip PATH changes and onboarding)\nREDEVEN_INSTALL_MODE=\"${REDEVEN_INSTALL_MODE:-install}\"\n\n# Optional explicit target version (for deterministic install/rollback)\nREDEVEN_VERSION=\"${REDEVEN_VERSION:-}\"\n\n# Version metadata endpoint (must be HTTPS)\nVERSION_MANIFEST_URL=\"${REDEVEN_VERSION_MANIFEST_URL}\"\n\n# Cosign identity constraint for SHA256SUMS signature verification.\nCOSIGN_CERT_IDENTITY_REGEXP='^https://github.com/floegence/redeven-agent/.github/workflows/release\\.yml@refs/tags/v.*$'\nCOSIGN_CERT_OIDC_ISSUER='https://token.actions.githubusercontent.com'\n\n# Installation directories\nINSTALL_DIR=\"${REDEVEN_HOME}/bin\"\nRG_TARGET=\"\"\nRG_ARCHIVE_NAME=\"\"\nRG_EXPECTED_SHA256=\"\"\n\n# Logging functions\nlog_info() {\n    printf \"${GREEN}[INFO]${NC} %s\\n\" \"$1\"\n}\n\nlog_warn() {\n    printf \"${YELLOW}[WARN]${NC} %s\\n\" \"$1\"\n}\n\nlog_error() {\n    printf \"${RED}[ERROR]${NC} %s\\n\" \"$1\"\n}\n\nvalidate_release_version() {\n    case \"$1\" in\n        v[0-9]*.[0-9]*.[0-9]*|v[0-9]*.[0-9]*.[0-9]*-[0-9A-Za-z.-]*|v[0-9]*.[0-9]*.[0-9]*+[0-9A-Za-z.-]*|v[0-9]*.[0-9]*.[0-9]*-[0-9A-Za-z.-]*+[0-9A-Za-z.-]*)\n            return 0\n            ;;\n        *)\n            return 1\n            ;;\n    esac\n}\n\n# Determine the best installation directory\ndetermine_install_dir() {\n    log_info \"Determining installation directory...\"\n\n    # Forced install directory: used for agent self-upgrade to ensure we overwrite the currently running binary path.\n    if [ -n \"${REDEVEN_INSTALL_DIR:-}\" ]; then\n        INSTALL_DIR=\"$REDEVEN_INSTALL_DIR\"\n        log_info \"Using forced install directory: $INSTALL_DIR\"\n        return 0\n    fi\n\n    # Preferred directories in order of priority:\n    # 1. /usr/local/bin - system-wide, already in PATH, requires write permission or sudo\n    # 2. ~/.redeven/bin - user-local, needs PATH configuration\n\n    # Check if we can write to /usr/local/bin\n    if [ -w \"/usr/local/bin\" ] || [ -w \"/usr/local\" ]; then\n        INSTALL_DIR=\"/usr/local/bin\"\n        log_info \"Using system directory: $INSTALL_DIR (already in PATH)\"\n        return 0\n    fi\n\n    # Check if we have sudo and user wants to use it\n    if command -v sudo >/dev/null 2>&1 && sudo -n true 2>/dev/null; then\n        INSTALL_DIR=\"/usr/local/bin\"\n        log_info \"Using system directory with sudo: $INSTALL_DIR (already in PATH)\"\n        return 0\n    fi\n\n    # Fall back to user directory\n    INSTALL_DIR=\"${REDEVEN_HOME}/bin\"\n    log_info \"Using user directory: $INSTALL_DIR (will configure PATH)\"\n    return 0\n}\n\n# Check if running in a supported shell environment\ncheck_environment() {\n    log_info \"Checking environment...\"\n\n    # Check if we can execute shell scripts\n    if [ -z \"$SHELL\" ]; then\n        log_error \"Cannot determine shell environment\"\n        exit 1\n    fi\n\n    # Check for required commands\n    for cmd in curl uname tar grep sed awk mktemp; do\n        if ! command -v \"$cmd\" >/dev/null 2>&1; then\n            log_error \"Required command not found: $cmd\"\n            exit 1\n        fi\n    done\n\n    log_info \"Environment check passed\"\n}\n\n# Detect operating system and architecture\ndetect_platform() {\n    log_info \"Detecting platform...\"\n\n    OS=$(uname -s | tr '[:upper:]' '[:lower:]')\n    ARCH=$(uname -m)\n\n    # Normalize OS name\n    case \"$OS\" in\n        linux*)\n            OS=\"linux\"\n            ;;\n        darwin*)\n            OS=\"darwin\"\n            ;;\n        msys*|mingw*|cygwin*)\n            log_error \"Windows native is not supported.\"\n            log_error \"Please use WSL (Windows Subsystem for Linux) to run Redeven agent.\"\n            log_error \"\"\n            log_error \"To install WSL, run in PowerShell as Administrator:\"\n            log_error \"  wsl --install\"\n            log_error \"\"\n            log_error \"Then run this installation script inside WSL.\"\n            exit 1\n            ;;\n        *)\n            log_error \"Unsupported operating system: $OS\"\n            exit 1\n            ;;\n    esac\n\n    # Normalize architecture name\n    case \"$ARCH\" in\n        x86_64|amd64)\n            ARCH=\"amd64\"\n            ;;\n        aarch64|arm64)\n            ARCH=\"arm64\"\n            ;;\n        armv7l|armv6l)\n            ARCH=\"arm\"\n            ;;\n        i386|i686)\n            ARCH=\"386\"\n            ;;\n        *)\n            log_error \"Unsupported architecture: $ARCH\"\n            exit 1\n            ;;\n    esac\n\n    PLATFORM=\"${OS}_${ARCH}\"\n    PACKAGE_NAME=\"${BINARY_NAME}_${PLATFORM}.tar.gz\"\n\n    case \"${OS}_${ARCH}\" in\n        linux_amd64)\n            RG_TARGET=\"x86_64-unknown-linux-musl\"\n            ;;\n        linux_arm64)\n            RG_TARGET=\"aarch64-unknown-linux-gnu\"\n            ;;\n        linux_arm)\n            RG_TARGET=\"armv7-unknown-linux-musleabihf\"\n            ;;\n        linux_386)\n            RG_TARGET=\"i686-unknown-linux-gnu\"\n            ;;\n        darwin_amd64)\n            RG_TARGET=\"x86_64-apple-darwin\"\n            ;;\n        darwin_arm64)\n            RG_TARGET=\"aarch64-apple-darwin\"\n            ;;\n        *)\n            log_error \"Unsupported platform for ripgrep: ${OS}_${ARCH}\"\n            exit 1\n            ;;\n    esac\n\n    RG_ARCHIVE_NAME=\"ripgrep-${RG_VERSION}-${RG_TARGET}.tar.gz\"\n    if ! RG_EXPECTED_SHA256=$(resolve_rg_sha256 \"$RG_TARGET\"); then\n        log_error \"No pinned checksum configured for ripgrep target: $RG_TARGET\"\n        exit 1\n    fi\n\n    log_info \"Detected platform: $PLATFORM\"\n}\n\nresolve_target_version() {\n    if [ -n \"$REDEVEN_VERSION\" ]; then\n        if ! validate_release_version \"$REDEVEN_VERSION\"; then\n            log_error \"Invalid REDEVEN_VERSION: $REDEVEN_VERSION\"\n            log_error \"Expected release tag format like v1.2.3\"\n            exit 1\n        fi\n        LATEST_VERSION=\"$REDEVEN_VERSION\"\n        VERSION_SOURCE=\"explicit\"\n        log_info \"Using explicit target version: $LATEST_VERSION\"\n        return 0\n    fi\n\n    resolve_version_from_manifest\n}\n\nsha256_file() {\n    target=\"$1\"\n    if command -v sha256sum >/dev/null 2>&1; then\n        sha256sum \"$target\" | awk '{print $1}'\n        return 0\n    fi\n    if command -v shasum >/dev/null 2>&1; then\n        shasum -a 256 \"$target\" | awk '{print $1}'\n        return 0\n    fi\n    log_error \"Neither sha256sum nor shasum is available for checksum verification\"\n    exit 1\n}\n\nresolve_rg_sha256() {\n    case \"$1\" in\n        x86_64-unknown-linux-musl)\n            printf '%s\\n' '4cf9f2741e6c465ffdb7c26f38056a59e2a2544b51f7cc128ef28337eeae4d8e'\n            ;;\n        aarch64-unknown-linux-gnu)\n            printf '%s\\n' 'c827481c4ff4ea10c9dc7a4022c8de5db34a5737cb74484d62eb94a95841ab2f'\n            ;;\n        armv7-unknown-linux-musleabihf)\n            printf '%s\\n' 'ec568e3c82054933cf22eced8eaffc1c93d38efcd505cb04df905f95e85d03a6'\n            ;;\n        i686-unknown-linux-gnu)\n            printf '%s\\n' '2ce1beccb27ce9ad8e26593be52b15e8da0ee7bf3e0e59d5553ab3333a087a4e'\n            ;;\n        x86_64-apple-darwin)\n            printf '%s\\n' 'fc87e78f7cb3fea12d69072e7ef3b21509754717b746368fd40d88963630e2b3'\n            ;;\n        aarch64-apple-darwin)\n            printf '%s\\n' '24ad76777745fbff131c8fbc466742b011f925bfa4fffa2ded6def23b5b937be'\n            ;;\n        *)\n            return 1\n            ;;\n    esac\n}\n\nverify_pinned_checksum() {\n    expected=\"$1\"\n    archive_file=\"$2\"\n    label=\"$3\"\n\n    actual=$(sha256_file \"$archive_file\" | tr -d '\\r\\n')\n\n    if [ \"$actual\" != \"$expected\" ]; then\n        log_error \"Checksum mismatch for $label\"\n        log_error \"Expected: $expected\"\n        log_error \"Actual:   $actual\"\n        exit 1\n    fi\n    log_info \"Checksum verification passed for $label\"\n}\n\nverify_signature() {\n    checksums_file=\"$1\"\n    sig_file=\"$2\"\n    cert_file=\"$3\"\n\n    if ! command -v cosign >/dev/null 2>&1; then\n        log_error \"cosign is required to verify release signatures\"\n        log_error \"Install cosign first: https://docs.sigstore.dev/cosign/system_config/installation/\"\n        exit 1\n    fi\n\n    log_info \"Verifying release signature...\"\n    if ! cosign verify-blob \\\n        --certificate \"$cert_file\" \\\n        --signature \"$sig_file\" \\\n        --certificate-identity-regexp \"$COSIGN_CERT_IDENTITY_REGEXP\" \\\n        --certificate-oidc-issuer \"$COSIGN_CERT_OIDC_ISSUER\" \\\n        \"$checksums_file\" >/dev/null 2>&1; then\n        log_error \"Signature verification failed\"\n        exit 1\n    fi\n    log_info \"Signature verification passed\"\n}\n\nverify_checksum() {\n    checksums_file=\"$1\"\n    archive_file=\"$2\"\n\n    expected=$(awk -v f=\"$PACKAGE_NAME\" '$2 == f || $2 == \"*\" f {print $1; exit}' \"$checksums_file\" | tr -d '\\r\\n')\n    if [ -z \"$expected\" ]; then\n        log_error \"Checksum entry not found for $PACKAGE_NAME\"\n        exit 1\n    fi\n\n    actual=$(sha256_file \"$archive_file\" | tr -d '\\r\\n')\n\n    if [ \"$actual\" != \"$expected\" ]; then\n        log_error \"Checksum mismatch for $PACKAGE_NAME\"\n        log_error \"Expected: $expected\"\n        log_error \"Actual:   $actual\"\n        exit 1\n    fi\n    log_info \"Checksum verification passed\"\n}\n\ndownload_with_fallback() {\n    primary_url=\"$1\"\n    fallback_url=\"$2\"\n    out_file=\"$3\"\n\n    if curl -fsSL \"$primary_url\" -o \"$out_file\"; then\n        return 0\n    fi\n\n    log_warn \"Primary download failed, trying fallback...\"\n    if curl -fsSL \"$fallback_url\" -o \"$out_file\"; then\n        return 0\n    fi\n\n    return 1\n}\n\n# Download and install redeven\ninstall_redeven() {\n    log_info \"Installing redeven...\"\n\n    # Create installation directory\n    mkdir -p \"$INSTALL_DIR\"\n\n    # Construct download URLs\n    GITHUB_DOWNLOAD_URL=\"${GITHUB_RELEASES_URL}/download/${LATEST_VERSION}/${PACKAGE_NAME}\"\n    GITHUB_SUMS_URL=\"${GITHUB_RELEASES_URL}/download/${LATEST_VERSION}/SHA256SUMS\"\n    GITHUB_SIG_URL=\"${GITHUB_RELEASES_URL}/download/${LATEST_VERSION}/SHA256SUMS.sig\"\n    GITHUB_CERT_URL=\"${GITHUB_RELEASES_URL}/download/${LATEST_VERSION}/SHA256SUMS.pem\"\n\n    CLOUDFLARE_BASE_URL=\"${REDEVEN_PACKAGE_MIRROR_BASE_URL}/agent-install-pkg/${LATEST_VERSION}\"\n    CLOUDFLARE_DOWNLOAD_URL=\"${CLOUDFLARE_BASE_URL}/${PACKAGE_NAME}\"\n    CLOUDFLARE_SUMS_URL=\"${CLOUDFLARE_BASE_URL}/SHA256SUMS\"\n    CLOUDFLARE_SIG_URL=\"${CLOUDFLARE_BASE_URL}/SHA256SUMS.sig\"\n    CLOUDFLARE_CERT_URL=\"${CLOUDFLARE_BASE_URL}/SHA256SUMS.pem\"\n\n    # Create temporary directory\n    TMP_DIR=$(mktemp -d)\n    trap 'rm -rf \"$TMP_DIR\"' EXIT\n\n    ARCHIVE_PATH=\"$TMP_DIR/redeven.tar.gz\"\n    SUMS_PATH=\"$TMP_DIR/SHA256SUMS\"\n    SIG_PATH=\"$TMP_DIR/SHA256SUMS.sig\"\n    CERT_PATH=\"$TMP_DIR/SHA256SUMS.pem\"\n\n    log_info \"Downloading package from GitHub: $GITHUB_DOWNLOAD_URL\"\n    if ! download_with_fallback \"$GITHUB_DOWNLOAD_URL\" \"$CLOUDFLARE_DOWNLOAD_URL\" \"$ARCHIVE_PATH\"; then\n        log_error \"Failed to download release package\"\n        log_error \"GitHub URL: $GITHUB_DOWNLOAD_URL\"\n        log_error \"Cloudflare URL: $CLOUDFLARE_DOWNLOAD_URL\"\n        exit 1\n    fi\n\n    log_info \"Downloading release checksums\"\n    if ! download_with_fallback \"$GITHUB_SUMS_URL\" \"$CLOUDFLARE_SUMS_URL\" \"$SUMS_PATH\"; then\n        log_error \"Failed to download SHA256SUMS\"\n        exit 1\n    fi\n\n    log_info \"Downloading release signature\"\n    if ! download_with_fallback \"$GITHUB_SIG_URL\" \"$CLOUDFLARE_SIG_URL\" \"$SIG_PATH\"; then\n        log_error \"Failed to download SHA256SUMS.sig\"\n        exit 1\n    fi\n\n    log_info \"Downloading release certificate\"\n    if ! download_with_fallback \"$GITHUB_CERT_URL\" \"$CLOUDFLARE_CERT_URL\" \"$CERT_PATH\"; then\n        log_error \"Failed to download SHA256SUMS.pem\"\n        exit 1\n    fi\n\n    verify_signature \"$SUMS_PATH\" \"$SIG_PATH\" \"$CERT_PATH\"\n    verify_checksum \"$SUMS_PATH\" \"$ARCHIVE_PATH\"\n\n    # Extract the binary\n    log_info \"Extracting binary...\"\n    # On some platforms (especially when archives are built on macOS),\n    # tar may emit harmless warnings like:\n    #   Ignoring unknown extended header keyword 'LIBARCHIVE.xattr.com.apple.provenance'\n    # For Linux, try to suppress these with --warning=no-unknown-keyword.\n    if [ \"$OS\" = \"linux\" ]; then\n        if ! tar --warning=no-unknown-keyword -xzf \"$ARCHIVE_PATH\" -C \"$TMP_DIR\" 2>/dev/null; then\n            # Fallback without the flag if tar does not support --warning\n            if ! tar -xzf \"$ARCHIVE_PATH\" -C \"$TMP_DIR\"; then\n                log_error \"Failed to extract binary\"\n                exit 1\n            fi\n        fi\n    else\n        if ! tar -xzf \"$ARCHIVE_PATH\" -C \"$TMP_DIR\"; then\n            log_error \"Failed to extract binary\"\n            exit 1\n        fi\n    fi\n\n    # Move binary to installation directory\n    if [ -f \"$TMP_DIR/$BINARY_NAME\" ]; then\n        # In forced install dir mode (agent self-upgrade), do not attempt sudo or interactive escalation; fail fast if not writable.\n        if [ -n \"${REDEVEN_INSTALL_DIR:-}\" ] && [ ! -w \"$INSTALL_DIR\" ]; then\n            log_error \"Forced install directory is not writable: $INSTALL_DIR\"\n            log_error \"Please reinstall the agent into a writable directory, or run the upgrade manually with appropriate permissions.\"\n            exit 1\n        fi\n\n        # Check if we need sudo for installation\n        if [ \"$INSTALL_DIR\" = \"/usr/local/bin\" ] && [ ! -w \"$INSTALL_DIR\" ]; then\n            log_info \"Installing to system directory (requires sudo)...\"\n            sudo mkdir -p \"$INSTALL_DIR\"\n            sudo mv \"$TMP_DIR/$BINARY_NAME\" \"$INSTALL_DIR/$BINARY_NAME\"\n            sudo chmod +x \"$INSTALL_DIR/$BINARY_NAME\"\n        else\n            mkdir -p \"$INSTALL_DIR\"\n            mv \"$TMP_DIR/$BINARY_NAME\" \"$INSTALL_DIR/$BINARY_NAME\"\n            chmod +x \"$INSTALL_DIR/$BINARY_NAME\"\n        fi\n        log_info \"Binary installed to: $INSTALL_DIR/$BINARY_NAME\"\n    else\n        log_error \"Binary not found in archive\"\n        exit 1\n    fi\n}\n\ninstall_ripgrep() {\n    log_info \"Installing ripgrep ${RG_VERSION}...\"\n\n    if [ -z \"$RG_TARGET\" ] || [ -z \"$RG_ARCHIVE_NAME\" ] || [ -z \"$RG_EXPECTED_SHA256\" ]; then\n        log_error \"ripgrep target metadata is missing\"\n        exit 1\n    fi\n\n    RG_GITHUB_URL=\"${RG_GITHUB_RELEASES_URL}/download/${RG_VERSION}/${RG_ARCHIVE_NAME}\"\n    RG_FALLBACK_URL=\"${RG_MIRROR_BASE_URL}/v${RG_VERSION}/${RG_ARCHIVE_NAME}\"\n\n    RG_TMP_DIR=$(mktemp -d)\n    RG_ARCHIVE_PATH=\"${RG_TMP_DIR}/${RG_ARCHIVE_NAME}\"\n\n    log_info \"Downloading ripgrep package from GitHub: $RG_GITHUB_URL\"\n    if ! download_with_fallback \"$RG_GITHUB_URL\" \"$RG_FALLBACK_URL\" \"$RG_ARCHIVE_PATH\"; then\n        log_error \"Failed to download ripgrep package\"\n        log_error \"GitHub URL: $RG_GITHUB_URL\"\n        log_error \"Cloudflare URL: $RG_FALLBACK_URL\"\n        rm -rf \"$RG_TMP_DIR\"\n        exit 1\n    fi\n\n    verify_pinned_checksum \"$RG_EXPECTED_SHA256\" \"$RG_ARCHIVE_PATH\" \"$RG_ARCHIVE_NAME\"\n\n    if [ \"$OS\" = \"linux\" ]; then\n        if ! tar --warning=no-unknown-keyword -xzf \"$RG_ARCHIVE_PATH\" -C \"$RG_TMP_DIR\" 2>/dev/null; then\n            if ! tar -xzf \"$RG_ARCHIVE_PATH\" -C \"$RG_TMP_DIR\"; then\n                log_error \"Failed to extract ripgrep package\"\n                rm -rf \"$RG_TMP_DIR\"\n                exit 1\n            fi\n        fi\n    else\n        if ! tar -xzf \"$RG_ARCHIVE_PATH\" -C \"$RG_TMP_DIR\"; then\n            log_error \"Failed to extract ripgrep package\"\n            rm -rf \"$RG_TMP_DIR\"\n            exit 1\n        fi\n    fi\n\n    RG_EXTRACTED_BINARY=\"${RG_TMP_DIR}/ripgrep-${RG_VERSION}-${RG_TARGET}/rg\"\n    if [ ! -f \"$RG_EXTRACTED_BINARY\" ]; then\n        log_error \"ripgrep binary not found in package\"\n        rm -rf \"$RG_TMP_DIR\"\n        exit 1\n    fi\n\n    RG_VERSION_DIR=\"${REDEVEN_TOOLS_DIR}/rg/${RG_VERSION}/${RG_TARGET}\"\n    RG_BINARY_PATH=\"${RG_VERSION_DIR}/rg\"\n    RG_LINK_PATH=\"${REDEVEN_HOME}/bin/rg\"\n\n    mkdir -p \"$RG_VERSION_DIR\"\n    mkdir -p \"${REDEVEN_HOME}/bin\"\n    cp \"$RG_EXTRACTED_BINARY\" \"$RG_BINARY_PATH\"\n    chmod +x \"$RG_BINARY_PATH\"\n    ln -sf \"$RG_BINARY_PATH\" \"$RG_LINK_PATH\"\n\n    rm -rf \"$RG_TMP_DIR\"\n\n    log_info \"ripgrep installed to: $RG_BINARY_PATH\"\n    log_info \"ripgrep symlink updated: $RG_LINK_PATH\"\n}\n\ncleanup_legacy_home() {\n    # Dev-stage breaking change: remove legacy ~/.redeven-agent to avoid stale state surprises.\n    if [ -n \"${HOME:-}\" ] && [ -e \"${HOME}/.redeven-agent\" ]; then\n        log_info \"Removing legacy directory: ${HOME}/.redeven-agent\"\n        rm -rf \"${HOME}/.redeven-agent\" 2>/dev/null || true\n    fi\n}\n\n# Add installation directory to PATH if needed\nsetup_path() {\n    log_info \"Checking PATH configuration...\"\n\n    # Check if INSTALL_DIR is already in PATH\n    case \":$PATH:\" in\n        *\":$INSTALL_DIR:\"*)\n            log_info \"✓ Installation directory is already in PATH\"\n            return 0\n            ;;\n    esac\n\n    # If installed to system directory, it should already be in PATH\n    if [ \"$INSTALL_DIR\" = \"/usr/local/bin\" ]; then\n        log_info \"✓ Installed to system directory (already in PATH)\"\n        return 0\n    fi\n\n    log_warn \"Installation directory is not in PATH\"\n    log_info \"Attempting to add to PATH automatically...\"\n\n    # Detect shell and corresponding config file\n    SHELL_NAME=$(basename \"$SHELL\")\n    SHELL_CONFIG=\"\"\n\n    case \"$SHELL_NAME\" in\n        bash)\n            # Try .bashrc first, then .bash_profile\n            if [ -f \"$HOME/.bashrc\" ]; then\n                SHELL_CONFIG=\"$HOME/.bashrc\"\n            elif [ -f \"$HOME/.bash_profile\" ]; then\n                SHELL_CONFIG=\"$HOME/.bash_profile\"\n            else\n                SHELL_CONFIG=\"$HOME/.bashrc\"\n            fi\n            ;;\n        zsh)\n            SHELL_CONFIG=\"$HOME/.zshrc\"\n            ;;\n        fish)\n            SHELL_CONFIG=\"$HOME/.config/fish/config.fish\"\n            ;;\n        *)\n            SHELL_CONFIG=\"$HOME/.profile\"\n            ;;\n    esac\n\n    # PATH export line to add (append to PATH).\n    PATH_EXPORT=\"export PATH=\\\"\\$PATH:$INSTALL_DIR\\\"\"\n\n    # Check if PATH is already configured in the shell config file\n    if [ -f \"$SHELL_CONFIG\" ] && grep -q \"$INSTALL_DIR\" \"$SHELL_CONFIG\" 2>/dev/null; then\n        log_info \"PATH already configured in $SHELL_CONFIG\"\n        log_warn \"Please restart your shell or run: source $SHELL_CONFIG\"\n        return 0\n    fi\n\n    # Add PATH to shell config file\n    log_info \"Adding PATH to $SHELL_CONFIG...\"\n\n    # Create config file if it doesn't exist\n    touch \"$SHELL_CONFIG\"\n\n    # Add PATH export with a comment\n    {\n        echo \"\"\n        echo \"# Added by Redeven agent installer\"\n        echo \"$PATH_EXPORT\"\n    } >> \"$SHELL_CONFIG\"\n\n    log_info \"PATH successfully added to $SHELL_CONFIG\"\n\n    # Store the source command for later use in summary\n    SOURCE_COMMAND=\"source $SHELL_CONFIG\"\n    export SOURCE_COMMAND\n\n    # Try to make the binary available in current session\n    # Note: This only works within the script's subprocess, not the parent shell\n    export PATH=\"$PATH:$INSTALL_DIR\"\n}\n\n# Print installation summary\nprint_summary() {\n    echo \"\"\n    log_info \"============================================\"\n    log_info \"Redeven CLI installed successfully!\"\n    log_info \"============================================\"\n    echo \"\"\n    log_info \"Installation details:\"\n    log_info \"  Binary: $INSTALL_DIR/$BINARY_NAME\"\n    log_info \"  Version: $LATEST_VERSION\"\n    log_info \"  Version source: $VERSION_SOURCE\"\n    log_info \"  ripgrep: ${REDEVEN_HOME}/bin/rg (v${RG_VERSION})\"\n    echo \"\"\n\n    # Test the binary immediately using full path\n    log_info \"Testing installation...\"\n    if \"$INSTALL_DIR/$BINARY_NAME\" version >/dev/null 2>&1; then\n        log_info \"✓ Binary is working correctly!\"\n    else\n        log_warn \"Binary test failed, but installation completed.\"\n    fi\n    echo \"\"\n\n    # Check if binary is in PATH\n    if command -v redeven >/dev/null 2>&1; then\n        log_info \"✓ 'redeven' command is ready to use in current session!\"\n        echo \"\"\n        log_info \"Try it now:\"\n        echo \"  redeven version\"\n    else\n        log_warn \"PATH has been configured, but not yet active in this session.\"\n        echo \"\"\n        log_info \"━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\"\n        log_info \"To start using 'redeven' command immediately, run this:\"\n        echo \"\"\n\n        # Detect shell and provide specific command\n        SHELL_NAME=$(basename \"$SHELL\")\n        ACTIVATE_CMD=\"\"\n        case \"$SHELL_NAME\" in\n            bash)\n                if [ -f \"$HOME/.bashrc\" ]; then\n                    ACTIVATE_CMD=\"source ~/.bashrc\"\n                else\n                    ACTIVATE_CMD=\"source ~/.bash_profile\"\n                fi\n                ;;\n            zsh)\n                ACTIVATE_CMD=\"source ~/.zshrc\"\n                ;;\n            fish)\n                ACTIVATE_CMD=\"source ~/.config/fish/config.fish\"\n                ;;\n            *)\n                ACTIVATE_CMD=\"source ~/.profile\"\n                ;;\n        esac\n\n        # Print the command in a highlighted box\n        echo \"    ${GREEN}${ACTIVATE_CMD}${NC}\"\n        echo \"\"\n        log_info \"━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\"\n        echo \"\"\n        log_info \"Alternatively:\"\n        log_info \"  • Open a new terminal window (PATH will be active automatically)\"\n        log_info \"  • Use full path: $INSTALL_DIR/$BINARY_NAME\"\n    fi\n\n    echo \"\"\n    log_info \"Next steps:\"\n    log_info \"  1. Create an account at ${REDEVEN_CONSOLE_URL}\"\n    log_info \"  2. Create a new environment in the dashboard\"\n    log_info \"  3. Click \\\"Setup environment\\\" and run the setup commands\"\n    echo \"\"\n    log_info \"For more information, visit: ${REDEVEN_DOCS_URL}\"\n    echo \"\"\n}\n\n# Main installation flow\nmain() {\n    if [ \"$REDEVEN_INSTALL_MODE\" = \"upgrade\" ]; then\n        log_info \"Starting Redeven agent upgrade...\"\n    else\n        log_info \"Starting Redeven agent installation...\"\n    fi\n    echo \"\"\n\n    # Check environment\n    check_environment\n\n    # Remove legacy config/state directory (dev-stage breaking change)\n    cleanup_legacy_home\n\n    # Determine installation directory\n    determine_install_dir\n\n    # Detect platform\n    detect_platform\n\n    # Resolve version\n    resolve_target_version\n\n    # Install redeven\n    install_redeven\n\n    # Install pinned ripgrep used by shell-first AI workflow\n    install_ripgrep\n\n    # Setup PATH + onboarding summary (skip in upgrade mode)\n    if [ \"$REDEVEN_INSTALL_MODE\" != \"upgrade\" ]; then\n        setup_path\n        print_summary\n    else\n        log_info \"Redeven agent upgraded successfully!\"\n        log_info \"Binary: $INSTALL_DIR/$BINARY_NAME\"\n        log_info \"Version: $LATEST_VERSION\"\n        log_info \"Version source: $VERSION_SOURCE\"\n        log_info \"ripgrep: ${REDEVEN_HOME}/bin/rg (v${RG_VERSION})\"\n    fi\n}\n\n# Run main function\nmain\n";

export default {
  async fetch(request, env, ctx) {
    const url = new URL(request.url);

    if (url.pathname !== "/install.sh") {
      // For all other paths, fall back to the origin.
      return fetch(request);
    }

    return new Response(INSTALL_SCRIPT, {
      status: 200,
      headers: {
        "Content-Type": "text/x-shellscript; charset=utf-8",
        "Content-Disposition": "inline; filename=\"install.sh\"",
        // Cache at the edge and in browsers for 10 minutes by default.
        "Cache-Control": "public, max-age=600, s-maxage=600",
      },
    });
  },
};
